
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>You're Speaking My Landscape, Baby. - HarveyNick.com</title>
  <meta name="author" content="Nick Johnson">

  
  <meta name="description" content="No, that isn&#8217;t a typo&#8230; but yes, it is a bad play on words. That&#8217;s the bad news. The good news: finally! A Clockwork Aphid &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.harveynick.com/blog/2010/10/19/youre-speaking-my-landscape-baby">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="http://feeds.feedburner.com/Harveynick" rel="alternate" title="HarveyNick.com" type="application/atom+xml">
    <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
  <!--link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css"-->
  <!--link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css"-->

  <!--link href='http://fonts.googleapis.com/css?family=Lobster' rel='stylesheet' type='text/css'>
  <!--link href='http://fonts.googleapis.com/css?family=Cabin' rel='stylesheet' type='text/css'-->
  <!--link href='http://fonts.googleapis.com/css?family=Vollkorn' rel='stylesheet' type='text/css'-->
  <!--link href='http://fonts.googleapis.com/css?family=Gentium+Book+Basic' rel='stylesheet' type='text/css'-->
  <!--link href='http://fonts.googleapis.com/css?family=Lobster+Two:700italic' rel='stylesheet' type='text/css'-->
  <link href='http://fonts.googleapis.com/css?family=Lobster|Ubuntu+Condensed|Gentium+Book+Basic' rel='stylesheet' type='text/css'>

  <!-- For third-generation iPad with high-resolution Retina display: -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="apple-touch-icon-144x144-precomposed.png">
  <!-- For iPhone with high-resolution Retina display: -->
  <link rel="apple-touch-icon-precomposed" sizes="114x114" href="apple-touch-icon-114x114-precomposed.png">
  <!-- For first- and second-generation iPad: -->
  <link rel="apple-touch-icon-precomposed" sizes="72x72" href="apple-touch-icon-72x72-precomposed.png">
  <!-- For non-Retina iPhone, iPod Touch, and Android 2.1+ devices: -->
  <link rel="apple-touch-icon-precomposed" href="apple-touch-icon-57x57-precomposed.png">


  <meta name="readability-verification" content="QUKCyxBsSkBLBb9EV6af7hEy2dheS7xF48kQqvNr"/>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-28082281-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>
  
  <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-38508260-1']);
  _gaq.push(['_setDomainName', 'adsensechallenge.com']);
  _gaq.push(['_setAllowLinker', true]);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">HarveyNick.com</a></h1>
  
    <h2>Something nerdy this way comes.</h2>
  
</hgroup>

</header>
  <!--div class="headerscaffold"></div-->
  <div id="shadow"></div>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/Harveynick" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:www.harveynick.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">You're Speaking My Landscape, Baby.</h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-10-19T16:55:39+01:00" pubdate data-updated="true">Oct 19<span>th</span>, 2010</time>
        
         | <a href="#disqus_thread">Comments</a>
        
        
          
        
      </p>
    
  </header>


<div class="entry-content"><p>No, that isn&#8217;t a typo&#8230; but yes, it is a bad play on words. That&#8217;s the bad news. The good news: finally! A Clockwork Aphid implementation post!</p>

<p>If you&#8217;re building something which relates in some way to virtual worlds, then the first thing you&#8217;re going to need <em>is</em> a virtual world. This gives you two options:</p>

<ol>
<li>Use a ready made one;</li>
<li>Roll your own.</li>
</ol>


<!-- more -->


<p>Option 1 is a possibility, and one that I&#8217;m going to come back to, but for now let&#8217;s think about option 2. So then, when building a virtual world the first thing you need is the lanscape. Once again you have two options, and let me just cut this short and say that I&#8217;m taking the second one. I did used to be a bit of a CAD ninja in a previous job, but I&#8217;m not a 3D modeller and I have no desire to build the landscape by hand.</p>

<p>So I&#8217;m going to generate one procedurally. As to what that means exactly, if you don&#8217;t already know&#8230; well I&#8217;m hoping that will become obvious as I go along.</p>

<h2>Traditional Fractal Landscape Generation</h2>

<p>There are several ways of generating a landscape. A pretty good one (and one I&#8217;m quite familiar with, thanks to a certain first year computer science assignment) is the fractal method. It goes something like this:<br/>
Start off with a square grid of floating point numbers, the length of whose sides are a power of two plus one. I&#8217;m going to use a 5*5 (2*2 + 1) grid for the purposes of this explanation.</p>

<p>Set the four corners to have the value 0.5 (the centre point of the range I&#8217;ll be using), thus:</p>

<p><img class="center" src="http://harveynick.files.wordpress.com/2010/10/fractallandscape1.png"></p>

<p>Now, we&#8217;re going to generate the landscape by repeatedly subdividing this and introducing fractal randomness (random fractility?) using the <a href="http://en.wikipedia.org/wiki/Diamond-square_algorithm">diamond square algorithm</a>. First the diamond step, which in this iteration will the set the value of the central cell based on the value of the four corners:</p>

<p><img class="center" src="http://harveynick.files.wordpress.com/2010/10/fractallandscape2.png"></p>

<p>To do this we take the average of the four corners (which I calculate to be 0.5 in this case, because I did maths at school) and adding a small randomly generated offset, which has been scaled according to the size of the subdivision we&#8217;re making. How exactly you do this varies between implementations, but a good simple way of doing it is use a random number in the range [-0.25,0.25] at this stage and half this at each subsequent iteration. So, on this occasion let&#8217;s say I roll the dice and come up with 0.23. This now leaves us with:</p>

<p><img class="center" src="http://harveynick.files.wordpress.com/2010/10/fractallandscape3.png"></p>

<p>Next, we have the square step, will set the cells in the centre of each of the sides. Once again we take the averages of other cells as starting point, this time in the following pattern:</p>

<p><img class="center" src="http://harveynick.files.wordpress.com/2010/10/fractallandscape4.png"></p>

<p>Now we generate more random numbers in the same range and use them to offset the average values, giving us this:</p>

<p><img class="center" src="http://harveynick.files.wordpress.com/2010/10/fractallandscape5.png"></p>

<p>That completes an iteration of the algorithm. Next we half the size of the range to [-0.125,0.125] and start again with the diamond step:</p>

<p><img class="center" src="http://harveynick.files.wordpress.com/2010/10/fractallandscape6.png"><!-- header_img http://harveynick.files.wordpress.com/2010/10/fractallandscape6.png --></p>

<p>&#8230;and so on until you&#8217;ve filled your grid. I think you get the general idea. I&#8217;ve left out one potentially important factor here and that&#8217;s &#8220;roughness,&#8221; which is an extra control you can use to adjust the appearance of the landscape. I&#8217;m going to come back to that in a later post, because (hopefully) I have a little more that I want to say about it. I need to play with it some more first, though.</p>

<p>Once you&#8217;ve finished here you can do a couple of different things if you want to actually look at your creation. The simplest is to pick a threshold value and call this &#8220;sea level,&#8221; then draw the grid as an image with pixels set to blue below the threshold and green above it:</p>

<p><img class="center" src="http://harveynick.files.wordpress.com/2010/10/image.png"></p>

<p>This was obviously generated with a slightly larger grid (513*513), but as you can see it creates quite reasonable coastlines. You can do slightly fancier things with it, such as more in depth colouring schemes and 3D display. For 3D, the simplest method is to use each cell as a vertex in your 3D space and tessellate the grid into triangles like this:</p>

<p><img class="center" src="http://harveynick.files.wordpress.com/2010/10/fractallandscape7.png"></p>

<p>You can then do a couple of fancy things to remove the triangles you don&#8217;t need, either based on the amount of detail they actually add or their distance from the user (level of detail).</p>

<p>This system works quite well, but tends to produce quite regular landscapes, without of the variation we&#8217;re used to or the things generated by rivers, differing geology, coastal erosion, glaciation and other forces which affect the landscape of the real world. Additionally, because the data is stored in a height map, there are some things it&#8217;s just not capable of displaying, such as shear cliffs, overhangs, and cave systems. The grid structure is also very efficient, but quite inflexible.</p>

<h2>How I&#8217;m Doing it</h2>

<p>Needless to say that&#8217;s not exactly how <em>I&#8217;m</em> doing it. Of course there&#8217;s generally very little sense in reinventing the wheel, but sometimes it&#8217;s fun to try.</p>

<p>I&#8217;m not doing too much differently with the actual algorithm, but I am using a slightly different data representation. Rather than a grid, I&#8217;m using discrete nodes. So you start off with something like this:</p>

<p><img class="center" src="http://harveynick.files.wordpress.com/2010/10/fractallandscape81.png"></p>

<p>Which then is transformed like this to generate the actual landscape:</p>

<p><img class="center" src="http://harveynick.files.wordpress.com/2010/10/fractallandscape9.png"></p>

<p>What you you can&#8217;t see from the diagrams is that I&#8217;m using fractions to address the individual nodes. So, for instance, the node in the centre is (1/2,1/2) and the node on the centre right is (1/1, 1/2). This means I don&#8217;t need to worry about how many nodes I have in the landscape, and the adress of each never has to change. The next set of nodes will be addressed using fractions with 4 as the denominator, then 8, 16 and so on. Before looking up a node you first reduce its coordinates down to a lowest common denominator (which is a factor of 2) and then pull it out of the correct layer. I&#8217;m currently using maps as sparse arrays to store the data in a structure which looks like this:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">Map</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">,</span> <span class="n">LandscapeNode</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you&#8217;re thinking that this isn&#8217;t possible in Java, you&#8217;re half right. I&#8217;m actually using one of <a href="http://trove4j.sourceforge.net/javadocs/gnu/trove/TIntObjectHashMap.html">these</a>. The first int addresses the denominator, then the east numerator, then the north numerator. I&#8217;ve looked at another couple of strategies for hashing the three ints together to locate a unique node but this one seems to work the best in terms of speed and memory usage. I might look at other options later, but nor yet.</p>

<p>This is a much more flexible representation, which removes some of the limitations of the grid. I can keep adding more detail to my heart&#8217;s content (up to a point) and I don&#8217;t have do it in a regular fashion. i.e. the native level of detail doesn&#8217;t have to be the same across the entire map. More remote areas can have less detail, for instance. By the same token, I can keep the entire &#8220;landscape&#8221; in memory, but flexibly pull individual nodes in or out depending on where the user actually is in the world, saving memory. This also potentially gives me the following:</p>

<ol>
<li>The possibility to decouple the geometry of the landscape from the topography of the representation;</li>
<li>A &#8220;native&#8221; way of implementing different levels of detail;</li>
<li>A natural tessellation strategy based on connecting a node to its parents (maybe you spotted it);</li>
<li>Enough data to allow the landscape to be modified to produce more dramatic features across different levels of detail;</li>
<li>The processes for the above should be very parallelisable.</li>
</ol>


<p>There are still a couple of things I&#8217;m working on (3D display for a start), as I&#8217;ve been obsessing over how to organise the data structures I&#8217;m using. Hopefully I&#8217;ll be back tomorrow with some 3D views.</p>

<p>If you&#8217;re interested in the code you can find it <a href="http://bitbucket.org/harveynick/clockworkaphidjava/overview">here</a>. If what you found at the end of that link didn&#8217;t make any sense to you, then you&#8217;re probably not a programmer (or you&#8217;re still learning). If you still want a look drop me a comment and I&#8217;ll see what I can do.</p>

<p>Disclaimer: As far as I&#8217;m aware I didn&#8217;t steel this from anybody, but I don&#8217;t claim it&#8217;s completely original, either.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">harveynick</span></span>

      








  


<time datetime="2010-10-19T16:55:39+01:00" pubdate data-updated="true">Oct 19<span>th</span>, 2010</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/hacker/'>Hacker</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://www.harveynick.com/blog/2010/10/19/youre-speaking-my-landscape-baby/" data-via="harveynick" data-counturl="http://www.harveynick.com/blog/2010/10/19/youre-speaking-my-landscape-baby/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2010/10/17/epic-googleyep-and-other-stories/" title="Previous Post: Epic Googleyep and Other Stories">&laquo; Epic Googleyep and Other Stories</a>
      
      
        <a class="basic-alignment right" href="/blog/2010/10/20/some-random-landscapes/" title="next Post: Some Random Landscapes">Some Random Landscapes &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <!-- h1>A Little Bit About Me</h1-->
  <br/>
  <p>This is the personal site of <a href="/about">Nick Johnson</a>, who is, among other things: 
  
    
    
    
  	  a <a href="/blog/categories/blogger">blogger</a>,
    
  
    
    
    
  	  an <a href="/blog/categories/audiophile">audiophile</a>,
    
  
    
    
    
  	  a <a href="/blog/categories/geek">geek</a>,
    
  
    
    
    
  	  a <a href="/blog/categories/hacker">hacker</a>,
    
  
    
    
    
  	  a <a href="/blog/categories/globetrotter">globetrotter</a>,
    
  
    
    
    
  	  a <a href="/blog/categories/foodie">foodie</a>,
    
  
    
    
    
  	  a <a href="/blog/categories/bibliophile">bibliophile</a>,
    
  
    
    
    
  	  a <a href="/blog/categories/cinephile">cinephile</a>,
    
  
    
    
    
      and a <a href="/blog/categories/gym-rat">gym rat</a>.
    
  
  <p><center><img src="http://www.gravatar.com/avatar/1eb55935486442c1e2b2455f85b9a771?s=140" width="140" height="140" /></center></p>
  </p>
</section>
<section>
  <div id="side-ad">
      <script type="text/javascript"><!--
        google_ad_client = "ca-pub-5573133722944342";
        /* Blog Sidebar */
        google_ad_slot = "3775287017";
        google_ad_width = 200;
        google_ad_height = 200;
        //-->
        </script>
        <script type="text/javascript"
        src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
      </script>
  </div>
</section><section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/04/19/perilously-close-to-perfection/">Perilously Close to Perfection</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/04/07/running-the-first-time/">Running, The First Time</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/04/01/a-fitness-story/">A Fitness Story</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/03/25/categories-and-goals/">Categories and Goals</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/03/22/ch-ch-ch-changes/">Ch-Ch-Ch-Changes</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/03/17/i-disagree-with-film-critic-hulk/">I Disagree with Film Critic Hulk</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/05/17/wandering-around-london/">Wandering Around London</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/04/14/now-were-blogging-with-photos/">Now We're Blogging with Photos!</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/03/27/origin/">Origin Story, Raspberry Pi, and the ZX Spectrum</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/03/17/new-ish-year-new-ish-blog/">New (ish) Year, New (ish) Blog</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("harveynick", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/harveynick" class="twitter-follow-button" data-show-count="false">Follow @harveynick</a>
  
</section>


  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Nick Johnson -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'harveynick-com';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://www.harveynick.com/blog/2010/10/19/youre-speaking-my-landscape-baby/';
        var disqus_url = 'http://www.harveynick.com/blog/2010/10/19/youre-speaking-my-landscape-baby/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
